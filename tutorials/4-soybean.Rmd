---
title: "Water and potassium on the production of soybean"
author: |
  | Wagner H. Bonat   | Walmes M. Zeviani |
  |:-----------------:|:-----------------:|
  | `wbonat@ufpr.br`  | `walmes@ufpr.br`  |
date: >
  63^a^ RBras & 17^o^ SEAGRO</br>
  July 24--28, 2017</br>
  UFLA, Lavras/MG
---

```{r, include = FALSE}
source("../slides/config/_setup.R")
```

# Data description and objectives

  * TODO
  * TODO

```{r}
#-----------------------------------------------------------------------
# Packages.

rm(list = ls())
library(lattice)
library(latticeExtra)
library(car)
library(candisc)
library(corrplot)
```

# MLM for the soybean dataset

```{r}
#-----------------------------------------------------------------------
# Multivariate analysis of the soybean dataset.

data(soybeanwp, package = "wzRfun")
str(soybeanwp)
head(soybeanwp)

# A copy with shorter names.
swp <- soybeanwp
# dput(names(swp))
names(swp) <- c("pts", "wtr", "blk",
                "yield", "w100", "Kconc", "tg", "nip", "nvp")

# Convert the controled numeric factors to categorical factors.
swp <- transform(swp,
                 Pts = factor(pts),
                 Wtr = factor(wtr))

# Creates the proportion of viable pods.
swp$pvp <- with(swp, nvp/(nvp + nip))
str(swp)

#-----------------------------------------------------------------------
# Data visulization.

# The 74 observation is an outlier to yield and tg.

combineLimits(
    useOuterStrips(
        xyplot(yield + tg + w100 + Kconc + pvp ~ pts | Wtr,
               outer = TRUE,
               as.table = TRUE,
               # data = swp[-74, ],
               data = swp,
               pch = 19,
               xlab = "Potassium",
               ylab = "Values",
               scales = list(y = "free"),
               groups = blk))) +
    layer(panel.xyplot(x = x, y = y, type = "a", col = 1))

#-----------------------------------------------------------------------
# Fitting the multivariate Gaussian linear model.

m0 <- lm(cbind(yield, tg, w100, Kconc, pvp) ~ blk + Wtr * Pts,
         data = swp[-74, ])

# MANOVA.
anova(m0)

# ANOVAs.
summary.aov(m0)

# Univariate model summaries.
# summary(m0)

# Estimated parameter.
coef(m0)

# Raw residuals.
r <- residuals(m0)
var(r)
cor(r)

# Change the 3rd color of the palette used for the ellipses.
oldpal <- palette()
palette(c("black", "blue", "red"))
scatterplotMatrix(r,
                  gap = 0,
                  smooth = FALSE,
                  reg.line = FALSE,
                  ellipse = TRUE,
                  diagonal = "qqplot")
palette(oldpal)

corrplot(cor(r),
         type = "upper",
         tl.pos = "d",
         outline = TRUE,
         method = "ellipse")

#-----------------------------------------------------------------------
# Canonical analysis.

cd_WP <- candisc(m0, term = "Wtr:Pts")
cd_WP
cd_WP$coeffs.raw
head(cd_WP$scores)
plot(cd_WP)

cd_P <- candisc(m0, term = "Pts")
cd_P
cd_P$coeffs.raw
head(cd_P$scores)
plot(cd_P)

cd_W <- candisc(m0, term = "Wtr")
cd_W
cd_W$coeffs.raw
head(cd_W$scores)
plot(cd_W)
```

```{r eval = FALSE, include = FALSE}
#-----------------------------------------------------------------------
# ATTENTION: code in tests.

# full <- cbind(yield, tg, w100, Kconc, pvp) ~ blk + Wtr * Pts
# null <- . ~ blk + Wtr + Pts
# data <- swp[-74, ]

gugudada <- function(full, null, data) {
    # Nested models.
    m_full <- lm(full, data)
    m_null <- update(m_full, null)
    # SSP.
    S_full <- crossprod(residuals(m_full))
    S_null <- crossprod(residuals(m_null))
    S_extr <- S_null - S_full
    # Eigen decomposition.
    ei <- eigen(solve(S_full, S_extr))
    print(ei)
    scores <- as.matrix(m_full$model[1]) %*% ei$vectors[, 1:2]
    plot(scores, asp = 1)
    print(anova(update(m_full, scores[, 1] ~ .)))
    print(anova(update(m_full, scores[, 2] ~ .)))
}

# Effect of interaction.
par(mfrow = c(1, 2))
plot(cd_WP)
grid()
gugudada(full = cbind(yield, tg, w100, Kconc, pvp) ~ blk + Wtr * Pts,
         null = . ~ blk + Wtr + Pts,
         data = swp[-74, ])
grid()
layout(1)

# Effect of Wtr.
par(mfrow = c(1, 2))
plot(cd_W)
grid()
gugudada(full = cbind(yield, tg, w100, Kconc, pvp) ~ blk + Pts + Wtr,
         null = . ~ blk + Pts,
         data = swp[-74, ])
grid()
layout(1)

# ATTENTION: This requires more study to fully understand.
#-----------------------------------------------------------------------
```

# Session information

```{r}
# devtools::session_info()
Sys.time()
cbind(Sys.info())
sessionInfo()
```
